<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Web Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 12px;
            color: #e4e4e7;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: #e4e4e7;
            margin-bottom: 20px;
            padding: 10px;
        }
        
        h1 {
            font-size: clamp(1.5em, 5vw, 2.5em);
            margin-bottom: 8px;
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            opacity: 0.7;
            font-size: clamp(0.9em, 3vw, 1.1em);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 350px), 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .card {
            background: rgba(30, 30, 46, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(129, 140, 248, 0.2);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(129, 140, 248, 0.2);
        }
        
        .card h2 {
            color: #818cf8;
            margin-bottom: 15px;
            font-size: clamp(1.1em, 4vw, 1.4em);
            border-bottom: 2px solid rgba(129, 140, 248, 0.3);
            padding-bottom: 10px;
        }
        
        h3 {
            color: #a5b4fc;
            margin: 15px 0 10px 0;
            font-size: clamp(0.95em, 3vw, 1.1em);
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: rgba(15, 15, 35, 0.8);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: #e4e4e7;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.1);
        }
        
        input[type="text"]::placeholder {
            color: #71717a;
        }
        
        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            touch-action: manipulation;
        }
        
        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(129, 140, 248, 0.4);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.danger {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
        }
        
        button.danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        button.success {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        }
        
        button.success:hover:not(:disabled) {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        button.small {
            padding: 8px 14px;
            font-size: 12px;
        }
        
        .model-list {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #818cf8 rgba(30, 30, 46, 0.5);
        }
        
        .model-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .model-list::-webkit-scrollbar-track {
            background: rgba(30, 30, 46, 0.5);
            border-radius: 4px;
        }
        
        .model-list::-webkit-scrollbar-thumb {
            background: #818cf8;
            border-radius: 4px;
        }
        
        .model-item {
            padding: 12px;
            border: 1px solid rgba(129, 140, 248, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            background: rgba(15, 15, 35, 0.5);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .model-item:hover {
            border-color: rgba(129, 140, 248, 0.5);
            background: rgba(15, 15, 35, 0.7);
        }
        
        .model-info {
            flex: 1;
            min-width: 0;
        }
        
        .model-name {
            font-weight: 600;
            color: #e4e4e7;
            font-size: 1em;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .model-details {
            font-size: 0.85em;
            color: #a1a1aa;
            word-break: break-word;
        }
        
        .model-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        @media (min-width: 640px) {
            .model-item {
                flex-direction: row;
                align-items: center;
            }
            
            .model-actions {
                flex-wrap: nowrap;
            }
        }
        
        .progress-container {
            margin-top: 15px;
        }
        
        .progress-item {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(15, 15, 35, 0.5);
            border: 1px solid rgba(129, 140, 248, 0.2);
            border-radius: 8px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #e4e4e7;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 24px;
            background: rgba(15, 15, 35, 0.8);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(129, 140, 248, 0.2);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #818cf8, #c084fc);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .progress-message {
            margin-top: 8px;
            font-size: 0.85em;
            color: #a1a1aa;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: clamp(400px, 60vh, 600px);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: rgba(15, 15, 35, 0.5);
            border: 1px solid rgba(129, 140, 248, 0.2);
            border-radius: 12px;
            margin-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: #818cf8 rgba(30, 30, 46, 0.5);
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(30, 30, 46, 0.5);
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #818cf8;
            border-radius: 4px;
        }
        
        .chat-message {
            margin-bottom: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.user {
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(129, 140, 248, 0.2);
            color: #e4e4e7;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .chat-input-group input {
            flex: 1;
            min-width: 200px;
        }
        
        @media (max-width: 640px) {
            .chat-input-group {
                flex-direction: column;
            }
            
            .chat-input-group input,
            .chat-input-group button {
                width: 100%;
            }
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-badge.running {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }
        
        .status-badge.stopped {
            background: rgba(161, 161, 170, 0.2);
            color: #a1a1aa;
            border: 1px solid rgba(161, 161, 170, 0.3);
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #71717a;
        }
        
        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        select {
            width: 100%;
            padding: 12px;
            background: rgba(15, 15, 35, 0.8);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 8px;
            font-size: 14px;
            color: #e4e4e7;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.1);
        }
        
        select option {
            background: #1a1a2e;
            color: #e4e4e7;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            max-width: calc(100% - 30px);
            padding: 14px 18px;
            background: rgba(30, 30, 46, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s;
            color: #e4e4e7;
        }
        
        .notification.show {
            display: block;
        }
        
        .notification.error {
            border-left: 4px solid #f87171;
        }
        
        .notification.success {
            border-left: 4px solid #34d399;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(129, 140, 248, 0.2);
            border-top: 3px solid #818cf8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        button.stop-button {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        button.stop-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .hidden {
            display: none;
        }
        
        pre {
            background: rgba(15, 15, 35, 0.8);
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 0.85em;
            color: #e4e4e7;
            border: 1px solid rgba(129, 140, 248, 0.2);
            scrollbar-width: thin;
            scrollbar-color: #818cf8 rgba(30, 30, 46, 0.5);
        }
        
        pre::-webkit-scrollbar {
            width: 6px;
        }
        
        pre::-webkit-scrollbar-track {
            background: rgba(30, 30, 46, 0.5);
            border-radius: 3px;
        }
        
        pre::-webkit-scrollbar-thumb {
            background: #818cf8;
            border-radius: 3px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            body {
                padding: 8px;
            }
            
            header {
                margin-bottom: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .grid {
                gap: 12px;
            }
            
            button {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .chat-message {
                max-width: 90%;
            }
            
            .notification {
                top: 10px;
                right: 10px;
                max-width: calc(100% - 20px);
                font-size: 0.9em;
            }
        }
        
        /* Landscape mobile optimization */
        @media (max-height: 600px) and (orientation: landscape) {
            .chat-container {
                height: clamp(300px, 50vh, 400px);
            }
        }
        
        /* Touch device improvements */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            input[type="text"],
            select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶ô Ollama Web Interface</h1>
            <p class="subtitle">Manage and interact with your Ollama models</p>
        </header>
        
        <div class="grid">
            <!-- Running Models -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">üîÑ Running Models</h2>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="small success" onclick="startOllama()">‚ñ∂ Start Ollama</button>
                        <button class="small danger" onclick="killOllama()">‚èπ Kill Ollama</button>
                    </div>
                </div>
                <div id="runningModels" class="model-list">
                    <div class="empty-state">
                        <div class="loading"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
            
            <!-- Pull Model -->
            <div class="card">
                <h2>‚¨áÔ∏è Pull Model</h2>
                <div class="input-group">
                    <input type="text" id="pullModelName" placeholder="Enter model name (e.g., llama2, mistral)">
                    <button onclick="pullModel()">Pull</button>
                </div>
                <div id="pullProgress" class="progress-container"></div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Available Models -->
            <div class="card">
                <h2>üì¶ Available Models</h2>
                <div id="availableModels" class="model-list">
                    <div class="empty-state">
                        <div class="loading"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="card">
            <h2>üí¨ Chat with Model</h2>
            <div style="margin-bottom: 15px;">
                <select id="chatModel" style="width: 100%;">
                    <option value="">Select a model...</option>
                </select>
            </div>
            <div class="chat-container">
                <div id="chatMessages" class="chat-messages">
                    <div class="empty-state">
                        <p>Select a model and start chatting!</p>
                    </div>
                </div>
                <div class="chat-input-group">
                    <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button id="sendButton" onclick="sendChat()">Send</button>
                    <button id="stopButton" class="stop-button hidden" onclick="stopGeneration()">‚èπ Stop</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        let pullingModels = new Set();
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function loadRunningModels() {
            fetch('/api/ps')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('runningModels');
                    if (data.success && data.models.length > 0) {
                        container.innerHTML = data.models.map(m => `
                            <div class="model-item">
                                <div class="model-info">
                                    <div class="model-name">${m.name}</div>
                                    <div class="model-details">
                                        Size: ${m.size} | Processor: ${m.processor} | Until: ${m.until}
                                    </div>
                                </div>
                                <div class="model-actions">
                                    <button class="small danger" onclick="stopModel('${m.name}')">Stop</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>No models running</p></div>';
                    }
                });
        }
        
        function loadAvailableModels() {
            fetch('/api/list')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('availableModels');
                    const chatSelect = document.getElementById('chatModel');
                    
                    if (data.success && data.models.length > 0) {
                        container.innerHTML = data.models.map(m => `
                            <div class="model-item">
                                <div class="model-info">
                                    <div class="model-name">${m.name}</div>
                                    <div class="model-details">
                                        ID: ${m.id} | Size: ${m.size}
                                    </div>
                                </div>
                                <div class="model-actions">
                                    <button class="small success" onclick="runModel('${m.name}')">‚ñ∂ Run</button>
                                    <button class="small" onclick="showModelInfo('${m.name}')">Info</button>
                                    <button class="small" onclick="copyModelPrompt('${m.name}')">Copy</button>
                                    <button class="small danger" onclick="removeModel('${m.name}')">Remove</button>
                                </div>
                            </div>
                        `).join('');
                        
                        // Update chat model selector
                        const currentValue = chatSelect.value;
                        chatSelect.innerHTML = '<option value="">Select a model...</option>' +
                            data.models.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
                        if (currentValue) chatSelect.value = currentValue;
                    } else {
                        container.innerHTML = '<div class="empty-state"><p>No models installed</p></div>';
                    }
                });
        }
        
        function pullModel() {
            let modelName = document.getElementById('pullModelName').value.trim();
            if (!modelName) {
                showNotification('Please enter a model name', 'error');
                return;
            }
            
            // Remove "ollama run" prefix if present
            modelName = modelName.replace(/^ollama\s+run\s+/i, '');
            
            fetch('/api/pull', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: modelName})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Started pulling ${modelName}`);
                    document.getElementById('pullModelName').value = '';
                    loadAllDownloads();
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        
        function loadAllDownloads() {
            fetch('/api/pull/all')
                .then(r => r.json())
                .then(downloads => {
                    const container = document.getElementById('pullProgress');
                    
                    // Get current download names
                    const downloadNames = Object.keys(downloads);
                    
                    if (downloadNames.length === 0) {
                        container.innerHTML = '';
                        return;
                    }
                    
                    // Update or create progress items
                    downloadNames.forEach(modelName => {
                        const data = downloads[modelName];
                        const progressId = `progress-${modelName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        
                        if (!document.getElementById(progressId)) {
                            // Create new progress item
                            const progressDiv = document.createElement('div');
                            progressDiv.id = progressId;
                            progressDiv.className = 'progress-item';
                            progressDiv.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: #e4e4e7;">${modelName}</span>
                                    <button class="small danger" id="${progressId}-cancel" onclick="cancelDownload('${modelName}')">‚úï Cancel</button>
                                </div>
                                <div class="progress-bar-bg">
                                    <div id="${progressId}-bar" class="progress-bar-fill" style="width: 0%">0%</div>
                                </div>
                                <div id="${progressId}-msg" style="margin-top: 8px; font-family: monospace; font-size: 0.9em; color: #a1a1aa;">Starting...</div>
                            `;
                            container.appendChild(progressDiv);
                        }
                        
                        // Update progress
                        const bar = document.getElementById(`${progressId}-bar`);
                        const msg = document.getElementById(`${progressId}-msg`);
                        const cancelBtn = document.getElementById(`${progressId}-cancel`);
                        const progressDiv = document.getElementById(progressId);
                        
                        if (bar && msg && progressDiv) {
                            const progress = data.progress || 0;
                            bar.style.width = `${progress}%`;
                            bar.textContent = `${progress}%`;
                            msg.textContent = data.message || 'Processing...';
                            
                            if (data.status === 'complete') {
                                progressDiv.style.borderColor = 'rgba(52, 211, 153, 0.5)';
                                msg.style.color = '#34d399';
                                if (cancelBtn) cancelBtn.style.display = 'none';
                                loadAvailableModels();
                            } else if (data.status === 'error') {
                                progressDiv.style.borderColor = 'rgba(248, 113, 113, 0.5)';
                                bar.style.background = 'linear-gradient(90deg, #f87171, #ef4444)';
                                msg.style.color = '#f87171';
                                if (cancelBtn) cancelBtn.style.display = 'none';
                                showNotification(`Download failed: ${data.message}`, 'error');
                            } else if (data.status === 'cancelled') {
                                progressDiv.style.borderColor = 'rgba(161, 161, 170, 0.5)';
                                bar.style.background = 'linear-gradient(90deg, #a1a1aa, #71717a)';
                                msg.style.color = '#71717a';
                                if (cancelBtn) cancelBtn.style.display = 'none';
                            }
                        }
                    });
                    
                    // Remove progress items that are no longer in the list
                    const allProgressItems = container.querySelectorAll('.progress-item');
                    allProgressItems.forEach(item => {
                        const itemId = item.id.replace('progress-', '').replace(/_/g, '');
                        const exists = downloadNames.some(name => 
                            name.replace(/[^a-zA-Z0-9]/g, '') === itemId
                        );
                        if (!exists) {
                            item.remove();
                        }
                    });
                });
        }
        
        function cancelDownload(modelName) {
            if (!confirm(`Cancel download of ${modelName}?`)) return;
            
            fetch('/api/pull/cancel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: modelName})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Cancelled ${modelName}`);
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        
        function stopModel(modelName) {
            fetch('/api/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: modelName})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Stopped ${modelName}`);
                    loadRunningModels();
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        
        function killOllama() {
            if (!confirm('Kill all Ollama processes? This will stop all running models.')) return;
            
            showNotification('Killing Ollama...');
            fetch('/api/kill', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('Ollama killed successfully');
                    setTimeout(() => {
                        loadRunningModels();
                        loadAvailableModels();
                    }, 1000);
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        
        function startOllama() {
            showNotification('Starting Ollama...');
            fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('Ollama started successfully');
                    setTimeout(() => {
                        loadRunningModels();
                        loadAvailableModels();
                    }, 2000);
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        
        function removeModel(modelName) {
            if (!confirm(`Are you sure you want to remove ${modelName}?`)) return;
            
            fetch('/api/rm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: modelName})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Removed ${modelName}`);
                    loadAvailableModels();
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        
        function copyModelPrompt(modelName) {
            const newName = prompt(`Copy "${modelName}" to:`, modelName + '-copy');
            if (!newName || newName === modelName) return;
            
            fetch('/api/cp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({source: modelName, destination: newName})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Copied ${modelName} to ${newName}`);
                    loadAvailableModels();
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        
        function runModel(modelName) {
            // Select the model in the chat dropdown
            const chatSelect = document.getElementById('chatModel');
            chatSelect.value = modelName;
            
            // Scroll to chat section
            document.querySelector('.card:last-child').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Focus on chat input
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 500);
            
            showNotification(`${modelName} loaded in chat`);
        }
        
        function showModelInfo(modelName) {
            showNotification('Loading model info...');
            
            fetch('/api/show', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model: modelName})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Create modal overlay
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                    
                    const content = document.createElement('div');
                    content.style.cssText = 'background: rgba(30, 30, 46, 0.98); border: 1px solid rgba(129, 140, 248, 0.3); border-radius: 16px; padding: 24px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 100%;';
                    content.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="color: #818cf8; margin: 0;">${modelName}</h2>
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="background: transparent; border: none; color: #a1a1aa; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
                        </div>
                        <pre style="background: rgba(15, 15, 35, 0.8); padding: 16px; border-radius: 8px; color: #e4e4e7; font-size: 0.85em; white-space: pre-wrap; word-wrap: break-word; max-height: 60vh; overflow-y: auto;">${data.output}</pre>
                    `;
                    
                    modal.appendChild(content);
                    document.body.appendChild(modal);
                } else {
                    showNotification(data.error, 'error');
                }
            });
        }
        

        
        let currentEventSource = null;
        
        function sendChat() {
            const model = document.getElementById('chatModel').value;
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const sendButton = document.getElementById('sendButton');
            const stopButton = document.getElementById('stopButton');
            
            if (!model) {
                showNotification('Please select a model', 'error');
                return;
            }
            
            if (!message) return;
            
            const messagesContainer = document.getElementById('chatMessages');
            
            // Clear empty state
            if (messagesContainer.querySelector('.empty-state')) {
                messagesContainer.innerHTML = '';
            }
            
            // Add user message
            messagesContainer.innerHTML += `
                <div class="chat-message user">${message}</div>
            `;
            
            input.value = '';
            input.disabled = true;
            sendButton.disabled = true;
            stopButton.classList.remove('hidden');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add assistant message container
            const assistantMsgId = 'assistant-msg-' + Date.now();
            messagesContainer.innerHTML += `
                <div class="chat-message assistant" id="${assistantMsgId}">
                    <div class="loading"></div>
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Start streaming
            fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({model, message})
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = '';
                
                function readStream() {
                    reader.read().then(({done, value}) => {
                        if (done) {
                            input.disabled = false;
                            sendButton.disabled = false;
                            stopButton.classList.add('hidden');
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    
                                    if (data.error) {
                                        document.getElementById(assistantMsgId).innerHTML = 
                                            `<span style="color: #e74c3c;">Error: ${data.error}</span>`;
                                        input.disabled = false;
                                        sendButton.disabled = false;
                                        stopButton.classList.add('hidden');
                                        return;
                                    }
                                    
                                    if (data.response) {
                                        accumulatedText += data.response;
                                        document.getElementById(assistantMsgId).textContent = accumulatedText;
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    }
                                    
                                    if (data.done) {
                                        input.disabled = false;
                                        sendButton.disabled = false;
                                        stopButton.classList.add('hidden');
                                        if (data.stopped) {
                                            document.getElementById(assistantMsgId).innerHTML += 
                                                '<br><em style="color: #95a5a6; font-size: 0.9em;">[Generation stopped]</em>';
                                        }
                                        return;
                                    }
                                } catch (e) {
                                    console.error('Parse error:', e);
                                }
                            }
                        }
                        
                        readStream();
                    }).catch(err => {
                        console.error('Stream error:', err);
                        document.getElementById(assistantMsgId).innerHTML = 
                            `<span style="color: #e74c3c;">Error: ${err.message}</span>`;
                        input.disabled = false;
                        sendButton.disabled = false;
                        stopButton.classList.add('hidden');
                    });
                }
                
                readStream();
            })
            .catch(err => {
                console.error('Fetch error:', err);
                document.getElementById(assistantMsgId).innerHTML = 
                    `<span style="color: #e74c3c;">Error: ${err.message}</span>`;
                input.disabled = false;
                sendButton.disabled = false;
                stopButton.classList.add('hidden');
            });
        }
        
        function stopGeneration() {
            fetch('/api/chat/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('Stopping generation...');
                }
            });
        }
        
        // Auto-refresh running models and downloads
        setInterval(loadRunningModels, 5000);
        setInterval(loadAllDownloads, 1000);
        
        // Initial load
        loadRunningModels();
        loadAvailableModels();
        loadAllDownloads();
    </script>
</body>
</html>
